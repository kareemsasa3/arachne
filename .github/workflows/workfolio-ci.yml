name: Build & Publish Images

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-workfolio:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          # Use SSH for submodules
          ssh-key: ${{ secrets.SUBMODULE_SSH_KEY }}
          ssh-strict: true

      - name: Verify submodule checkout
        run: |
          git submodule status || true
          git submodule sync --recursive
          git submodule update --init --recursive
          ls -la
          ls -la services/workfolio
          test -f services/workfolio/Dockerfile && echo "Found services/workfolio/Dockerfile" || (echo "Missing services/workfolio/Dockerfile" && exit 1)

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR (main/master only)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Workfolio image (local, PRs only)
        if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master'
        uses: docker/build-push-action@v5
        with:
          context: ./services/workfolio
          load: true
          push: false
          tags: |
            workfolio:ci
          build-args: |
            VITE_TURNSTILE_SITE_KEY=${{ secrets.VITE_TURNSTILE_SITE_KEY }}
            VITE_AI_URL=/api/ai

      - name: Build and push Workfolio image (GHCR, main/master only)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: docker/build-push-action@v5
        with:
          context: ./services/workfolio
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/workfolio:${{ github.sha }}
            ghcr.io/${{ github.repository }}/workfolio:${{ github.ref_name }}
            ghcr.io/${{ github.repository }}/workfolio:latest
          build-args: |
            VITE_TURNSTILE_SITE_KEY=${{ secrets.VITE_TURNSTILE_SITE_KEY }}
            VITE_AI_URL=/api/ai

      - name: Scan Workfolio image with Trivy (local)
        if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master'
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: image
          image-ref: workfolio:ci
          format: table
          severity: CRITICAL
          exit-code: 1

      - name: Scan Workfolio image with Trivy (remote)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: image
          image-ref: ghcr.io/${{ github.repository }}/workfolio:${{ github.sha }}
          format: table
          severity: CRITICAL
          exit-code: 1

      # Alternative: build from within the submodule directory
      # - name: Build (working-directory: services/workfolio)
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: ./services/workfolio
      #     file: ./services/workfolio/Dockerfile
      #     load: true
      #     tags: workfolio:ci
      #     build-args: |
      #       VITE_TURNSTILE_SITE_KEY=${{ secrets.VITE_TURNSTILE_SITE_KEY }}
#       VITE_AI_URL=${{ secrets.VITE_AI_URL }}

  build-ai:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          ssh-key: ${{ secrets.SUBMODULE_SSH_KEY }}
          ssh-strict: true
      - name: Verify submodule checkout (ai)
        run: |
          git submodule status || true
          git submodule sync --recursive
          git submodule update --init --recursive
          ls -la
          ls -la services
          ls -la services/ai
          test -f services/ai/Dockerfile && echo "Found services/ai/Dockerfile" || (echo "Missing services/ai/Dockerfile" && exit 1)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR (main/master only)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build ai image (local, PRs only)
        if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master'
        uses: docker/build-push-action@v5
        with:
          context: ./services/ai
          load: true
          push: false
          tags: |
            ai:ci

      - name: Build and push ai image (GHCR, main/master only)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: docker/build-push-action@v5
        with:
          context: ./services/ai
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/ai:${{ github.sha }}
            ghcr.io/${{ github.repository }}/ai:${{ github.ref_name }}
            ghcr.io/${{ github.repository }}/ai:latest

      - name: Scan ai image with Trivy (local)
        if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master'
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: image
          image-ref: ai:ci
          format: table
          severity: CRITICAL
          exit-code: 1

      - name: Scan ai image with Trivy (remote)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: image
          image-ref: ghcr.io/${{ github.repository }}/ai:${{ github.sha }}
          format: table
          severity: CRITICAL
          exit-code: 1

  build-scraper:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          ssh-key: ${{ secrets.SUBMODULE_SSH_KEY }}
          ssh-strict: true
      - name: Verify submodule checkout (scraper)
        run: |
          git submodule status || true
          git submodule sync --recursive
          git submodule update --init --recursive
          ls -la
          ls -la services
          ls -la services/scraper
          test -f services/scraper/Dockerfile && echo "Found services/scraper/Dockerfile" || (echo "Missing services/scraper/Dockerfile" && exit 1)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR (main/master only)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build scraper image (local, PRs only)
        if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master'
        uses: docker/build-push-action@v5
        with:
          context: ./services/scraper
          load: true
          push: false
          tags: |
            scraper:ci

      - name: Build and push scraper image (GHCR, main/master only)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: docker/build-push-action@v5
        with:
          context: ./services/scraper
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/scraper:${{ github.sha }}
            ghcr.io/${{ github.repository }}/scraper:${{ github.ref_name }}
            ghcr.io/${{ github.repository }}/scraper:latest

      - name: Scan scraper image with Trivy (local)
        if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master'
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: image
          image-ref: scraper:ci
          format: table
          severity: CRITICAL
          exit-code: 1

      - name: Scan scraper image with Trivy (remote)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: image
          image-ref: ghcr.io/${{ github.repository }}/scraper:${{ github.sha }}
          format: table
          severity: CRITICAL
          exit-code: 1

  build-web:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          ssh-key: ${{ secrets.SUBMODULE_SSH_KEY }}
          ssh-strict: true
      - name: Verify submodule checkout (web)
        run: |
          git submodule status || true
          git submodule sync --recursive
          git submodule update --init --recursive
          ls -la
          ls -la services
          ls -la services/web
          test -f services/web/Dockerfile && echo "Found services/web/Dockerfile" || (echo "Missing services/web/Dockerfile" && exit 1)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR (main/master only)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build web image (local, PRs only)
        if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master'
        uses: docker/build-push-action@v5
        with:
          context: ./services/web
          load: true
          push: false
          tags: |
            web:ci

      - name: Build and push web image (GHCR, main/master only)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: docker/build-push-action@v5
        with:
          context: ./services/web
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/web:${{ github.sha }}
            ghcr.io/${{ github.repository }}/web:${{ github.ref_name }}
            ghcr.io/${{ github.repository }}/web:latest

      - name: Scan web image with Trivy (local)
        if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master'
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: image
          image-ref: web:ci
          format: table
          severity: CRITICAL
          exit-code: 1

      - name: Scan web image with Trivy (remote)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: image
          image-ref: ghcr.io/${{ github.repository }}/web:${{ github.sha }}
          format: table
          severity: CRITICAL
          exit-code: 1
